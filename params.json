{"name":"Cogere","tagline":"Broadcast commands to remote hosts via SSH","body":"# cogere\r\nBroadcast commands to remote hosts via SSH\r\n\r\n# Usage\r\n```\r\ncogere -- verb: to collect/gather, to compel/force\r\n\r\nUsage: cogere --reason 'report hostname' --host-list host1,host2 'hostname'\r\n\r\nOperations:\r\n  -l|--host-list  Comma separated hostname list, command is executed on hosts\r\n                    if no other operations provided.\r\n                    Requires --reason\r\n  --add-host      Creates new host entry and keys remote host.\r\n                    Requires --hostname, --ipaddr. Optionally --username\r\n  --del-host      Removes host entry and remove key from remote host\r\n                    Requires --hostname\r\n  --rekey-hosts   Creates new SSH key, removes old SSH key and installs\r\n                    new SSH key on remote host.\r\n                    Requires --host-list\r\n  -g|--group      Comma separated group list, command is executed on groups\r\n                    if no other operations provided.\r\n                    Requires --reason\r\n  --add-group     Creates new group of hosts.\r\n                    Requires --group, --host-list\r\n  --del-group     Delete group.\r\n                    Requires --group\r\n  --join-group    Adds hosts to an existing group.\r\n                    Requires --group, --host-list\r\n  --leave-group   Remove hosts from an existing group.\r\n                    Requires --group, --host-list\r\n\r\nOptions:\r\n  -h|--help           Shows this output\r\n  -f|--config         Alternate configuration file\r\n  --hostname          Hostname to be provided to --add-host or --del-host\r\n  --ipaddr            IP address to be provided to --add-host\r\n  --username          User name to be provided to --add-host\r\n                        Optional, 'cogere' is used by default\r\n  -r|--reason         Explanation of the command you are running\r\n  -a|--all            Builds a group of all defined hosts.\r\n  -F|--fork           Forks supplied number of connections and waits for them\r\n                        to complete, the continues. The keywords 'a' or 'all'\r\n                        will produce a fork number equal to the number of\r\n                        hosts supplied\r\n  -H|--list-hosts     Displays all defined hosts\r\n  -G|--list-groups    Displays all defined groups\r\n  -M|--list-members   Displays all hosts within group\r\n                        Requires --group\r\n\r\nJohn Shields - SmartVault Corporation - 2015\r\n```\r\n### Example\r\n```\r\ncogere -a -r 'report hostname' hostname\r\narbitrium.jar00n.net\r\ncognitio.watministrator.net\r\n\r\n```\r\n### Installation\r\n\r\n`cogere` expects to be installed within the directory `/opt/sv`. The files in `bin`, `cogere` and `lib` are built with the assumed relative path of `/opt/sv`. If you install this tool into another directory you will either need to update the default directory variable within `bin/cogere` or always supply the `--config|-f` switch to load the alternate configuration.\r\n\r\n#### Configuration\r\n\r\nYou will need to setup the configuration file `cogere/cogere.conf` for you environment. The defaults within `cogere/cogere.conf` should be sufficient for your needs. Though you will likely need to remove the logstash entry from the log_type list.\r\n\r\n##### Logging\r\n\r\nThe `logstash` type is intended for use with a logstash listener on a TCP/UDP port with a filter performing JSON parsing.\r\nThe `file` type simply write to the defined `log_file`.\r\n\r\n#### sudo\r\n\r\n`cogere` expects to be ran under `sudo` and will not run if sudo was not invoked. This is for logging purposes.\r\n\r\nOnce all three directories (`bin`, `cogere`, `lib`) are installed within the same parent directory you will need to allow your user account(s) to run the tool via sudo. By convention we use the group `admin` to run this tool.\r\n\r\nExample sudo config:\r\n```\r\nCmnd_Alias COGERE = /opt/sv/bin/cogere\r\n%admin ALL=NOPASSWD:COGERE\r\n```\r\n\r\nTo simplify the use of the tool I create the following alias for all users, I add it to the `/etc/profile` file:\r\n\r\nExample alias definition:\r\n```\r\nalias cogere='sudo /opt/sv/bin/cogere'\r\n```\r\n\r\n### Documentation\r\n\r\n#### Operations\r\n\r\nOperations perform a given operation on a set of supplied parameters from the options detailed below. If multiple operations are provided, only one will be performed.\r\n\r\n**Don't supply multiple operations.**\r\n\r\n###### --host-list | -l\r\n\r\nThe `--host-list` switch is both an operation and an option. When using another operation it provides the list of hosts to the operation.\r\n\r\nIf ran with no other operations, it runs the supplied command on the host. Can supply multiple hosts comma separated\r\n\r\n**REQUIRES `--reason|-r`, `command`**\r\n\r\nExample:\r\n```\r\ncogere --reason 'report hostname' --host-list arbitrium,cognitio 'hostname'\r\narbitrium.jar00n.net\r\ncognitio.watministrator.net\r\n```\r\n\r\n###### --group | -g\r\n\r\nThe `--group` switch is both an operation and an option. When using another operation it evaluates the group(s) to a list of hosts for the operation.\r\n\r\nIf ran with no other operations, it runs the supplied command on the group. Can supply multiple groups comma separated.\r\n\r\n**REQUIRES `--reason|-r`, `command`**\r\n\r\nExample:\r\n```\r\ncogere --reason 'report hostname' --group testing 'hostname'\r\narbitrium.jar00n.net\r\ncognitio.watministrator.net\r\n```\r\n\r\n###### --add-host\r\n\r\nAdds the supplied host to the hosts configuration. The command must be provided `--hostname` and `--ipaddr` containing the hostname and IP address of the node. Optionally takes a `--username`, the default username is cogere.\r\n\r\n**REQUIRES `--hostname`, `--ipaddr`**\r\n**OPTIONAL `--username`**\r\n\r\nExample:\r\n```\r\ncogere --add-host --hostname cognitio --ipaddr 172.16.0.6\r\n/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed\r\n/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys\r\nWARNING : Unauthorized access to this system is forbidden and will be\r\nprosecuted by law. By accessing this system, you agree that your actions\r\nmay be monitored if unauthorized usage is suspected.\r\ncogere@172.16.0.6's password:\r\n```\r\n\r\n*I suggest that you remove the account's password once keyed.*\r\n\r\n###### --del-host\r\n\r\nDeletes the supplied host from the local hosts configuration, removes the SSH key from the node and deletes the local SSH keys for the node. Also removes host from any groups\r\n\r\n**REQUIRES `--hostname`**\r\n\r\nExample:\r\n```\r\ncogere --del-host --hostname cognitio\r\n```\r\n\r\n###### --add-group\r\n\r\nCreates a new group using the supplied group name, adding members to the group from the provided host list\r\n\r\n**REQUIRES `--group|-g`, `--host-list`**\r\n\r\nExample:\r\n```\r\ncogere --add-group --group moar-hosts --host-list arbitrium\r\n```\r\n###### --del-group\r\n\r\nDeletes supplied group. Does not delete host entries.\r\n\r\n**REQUIRES `--group|-g`**\r\n\r\nExample:\r\n```\r\ncogere --del-group --group moar-hosts\r\n```\r\n\r\n###### --join-group\r\n\r\nAdds provided hosts to provided group\r\n\r\n**REQUIRES `--group|-g`, `--host-list|-l`**\r\n\r\nExample:\r\n```\r\ncogere --join-group --group moar-hosts --host-list cognitio\r\n```\r\n\r\n###### --leave-group\r\n\r\nRemoves provided hosts to provided group\r\n\r\n**REQUIRES `--group|-g`, `--host-list|-l`**\r\n\r\nExample:\r\n```\r\ncogere --leave-group --group moar-hosts --host-list arbitrium\r\n```\r\n\r\n##### Options\r\n\r\nOptions are optional parameters unless other noted for given operation.\r\n\r\n###### --config | -f\r\n\r\nAllows for loading of a different configuration file. You likely won't ever use this.\r\n\r\n###### --hostname\r\n\r\nProvides hostname variable to `--add-host` or `--del-host`\r\n\r\n###### --ipaddr\r\n\r\nProvides IP address variable to `--add-host` or `--del-host`\r\n\r\n###### --reason | -r\r\n\r\nProvides a reason as to why you are doing what you are doing on the host-list or group\r\n\r\n###### --all | -a\r\n\r\nBuilds a `--host-list` of all defined hosts.\r\n\r\n###### --fork | -F\r\n\r\nThe `--fork|-F` option allows the script to process connections in parallel. This option takes either an integer for max number of concurrent connections or the keywords `a` or `all` to produce an integer for all hosts supplied.\r\n\r\nWhen forking is used, all lines are prefixed with the hostname the line came from.\r\n\r\nExample:\r\n```\r\ncogere -r 'forking' -a -F a 'for i in {0..5}; do sleep $(( $RANDOM % 3 )); echo $i; done'\r\n[arbitrium] 0\r\n[cognitio] 0\r\n[cognitio] 1\r\n[cognitio] 2\r\n[arbitrium] 1\r\n[cognitio] 3\r\n[arbitrium] 2\r\n[cognitio] 4\r\n[cognitio] 5\r\n[arbitrium] 3\r\n[arbitrium] 4\r\n[arbitrium] 5\r\n\r\n```\r\n\r\n###### --list-hosts | -H\r\n\r\nLists all defined hosts.\r\n\r\nExample:\r\n```\r\ncogere --list-hosts\r\narbitrium\r\ncognitio\r\n```\r\n\r\n###### --list-groups | -G\r\n\r\nLists all defined groups and their members.\r\n\r\nExample:\r\n```\r\ncogere --list-groups\r\nmoar-hosts - cognitio\r\ntesting - arbitrium\r\n```\r\n\r\n###### --list-members | -M\r\n\r\nLists members of supplied group\r\n\r\n**REQUIRES `--group|-g`**\r\n\r\nExample:\r\n```\r\ncogere --list-members --group testing\r\ntesting - arbitrium\r\n```\r\n\r\n##### Notes\r\n\r\nThese are various examples and use cases demonstrating the tool's functionality.\r\n\r\n###### Heredocs\r\n\r\nYou can supply heredocs as the command if they properly shell escaped.\r\n\r\nExample:\r\n```\r\ncogere -r 'heredoc demo' -a 'perl <<'\\''EOF'\\'\r\nuse strict;\r\nuse warnings;\r\n\r\nuse Sys::Hostname;\r\n\r\nprint \"Hi! My name is ${\\hostname}\\n\";\r\n\r\nexit;\r\nEOF\r\necho My username is $(whoami)\r\necho\r\n'\r\nHi! My name is arbitrium.jar00n.net\r\nMy username is cogere\r\n\r\nHi! My name is cognitio.watministrator.net\r\nMy username is cogere\r\n\r\n```\r\n\r\n**Remember: To escape a single quote use the following sequence `'\\''`**\r\n\r\n###### Forking\r\n\r\nIt is important to note that output lines are only sent back when the remote side flushes their buffers. So, if you cat a file it will be printed intact on the cogere side.\r\n\r\nExample:\r\n```\r\ncogere -r 'stdout forking' -a -F a 'head -n3 /etc/hosts'\r\n[arbitrium] 127.0.0.1\tlocalhost\r\n[arbitrium] 127.0.1.1\tarbitrium.jar00n.net\tarbitrium\r\n[arbitrium] \r\n[cognitio] 127.0.0.1\tlocalhost\r\n[cognitio] 127.0.1.1\tcognitio.watministrator.net cognitio\r\n[cognitio] \r\n```\r\n\r\nHowever, if the output is flushed on each line, then the output will be printed one line at a time causing the output on cogere to be intermixed with lines from the hosts being connected to.\r\n\r\nExample:\r\n```\r\ncogere -r 'stdout forking' -a -F a 'while read line; do echo \"$line\"; sleep 1; done < <(head -n3 /etc/hosts)'\r\n[arbitrium] 127.0.0.1\tlocalhost\r\n[cognitio] 127.0.0.1\tlocalhost\r\n[arbitrium] 127.0.1.1\tarbitrium.jar00n.net\tarbitrium\r\n[cognitio] 127.0.1.1\tcognitio.watministrator.net cognitio\r\n[arbitrium] \r\n[cognitio] \r\n```\r\n\r\nHere I used `sleep` to break up the command output to ensure the lines were sent one at a time, depending on the speed of the operation all lines could be sent in tact like the previous example.\r\n\r\n### To do's\r\n- Allow for hostname negation\r\n- Replace comma separated hosts/groups with multiple `-l/g` switches (Allows for tab completion)\r\n- Allow for host removal of unreachable hosts\r\n- Allow for use of preexisting key in `--add-host` (Allows for automated deploy hosts to be already keyed, will rekey on add)\r\n- Allow for hosts to added to groups on creation\r\n- Optionally use DNS if `--ipaddr` not provided with `--add-host`\r\n- Build tab completion file\r\n- Add verbosity to commands with no output (Add/Del Host/Group)\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}